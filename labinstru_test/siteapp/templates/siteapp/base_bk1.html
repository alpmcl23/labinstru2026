{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}LabInstru{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <style>
    .sidebar { width: 260px; background: #fff; border-right: 1px solid #e6eef7; padding: 16px; position: sticky; top: 0; height: 100vh;}
    .nav-link { color:#0d6efd; font-weight:600; }
    .nav-link.active, .nav-link:hover { color:#0a58ca; }
    .brand img { height: 42px; border-radius: 8px; }
    .labinstru-card { background:#f3fafe; border-radius:16px; padding:16px; border:1.5px solid #d6e7f7; box-shadow:0 2px 12px #05445e11; margin-bottom:16px; }
    .content-wrap { flex: 1; padding: 18px; }
    /* ZEUS chat (sidebar button floating) */
    #zeus-btn { position: fixed; right: 18px; bottom: 18px; z-index: 9999; }
    #zeus-panel { position: fixed; right: 18px; bottom: 70px; width: 360px; max-width: 95vw;
                  background: #f6f8fb; border: 1.7px solid #d0e1f3; border-radius: 12px; display:none; flex-direction: column; box-shadow:0 8px 20px #0002; z-index: 9999; }
    #zeus-header { background: linear-gradient(90deg, #1976d2 80%, #56c6e6 100%); color:#fff; padding:10px 12px; display:flex; align-items:center; gap:10px; border-radius: 12px 12px 0 0; }
    #zeus-mensagens { padding:10px; height: 280px; overflow-y: auto; }
    .z-assistant { background:#e1eefc; padding:8px 12px; border-radius: 8px; margin:6px 0; }
    .z-user { background:#d2f5db; padding:8px 12px; border-radius: 8px; margin:6px 0; text-align:right; }
  </style>
</head>
<body>
  <div class="d-flex">
    <aside class="sidebar d-none d-lg-flex flex-column">
      <a class="brand mb-3 d-flex align-items-center gap-2 text-decoration-none" href="{% url 'home' %}">
        <img src="{% static 'logo.png' %}" alt="LabInstru">
        <span class="fw-bold text-dark">LabInstru</span>
      </a>
      <nav class="nav flex-column gap-1">
        <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">Home</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'quem_somos' %}active{% endif %}" href="{% url 'quem_somos' %}">Quem Somos</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'dashboard' %}">Dashboard</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'rede_hobo' %}active{% endif %}" href="{% url 'rede_hobo' %}">Rede de Estações HOBO</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'condicoes' %}active{% endif %}" href="{% url 'condicoes' %}">Condições atuais</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'satelite_radar' %}active{% endif %}" href="{% url 'satelite_radar' %}">Satélite e radar</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'estagio' %}active{% endif %}" href="{% url 'estagio' %}">Estágio Curricular</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'projetos' %}active{% endif %}" href="{% url 'projetos' %}">Projetos</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'eventos' %}active{% endif %}" href="{% url 'eventos' %}">Eventos</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'contato' %}active{% endif %}" href="{% url 'contato' %}">Contato</a>
      </nav>
    </aside>
    <main class="content-wrap container-fluid">
      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Floating Zeus widget -->
  <button id="zeus-btn" class="btn btn-success fw-bold">Abrir Zeus</button>
  <div id="zeus-panel">
    <div id="zeus-header">
      <strong>ZEUS</strong>
      <button class="btn btn-sm btn-light ms-auto" onclick="toggleZeus()">Fechar</button>
    </div>
    <div id="zeus-mensagens">
      <div class="z-assistant">Olá! ⚡ Eu sou <b>ZEUS</b>, seu assistente meteorológico. Pergunte sobre previsão, mapas ou fenômenos climáticos!</div>
    </div>
    <div class="p-2 d-flex gap-2">
      <input id="zeus-input" class="form-control" placeholder="Pergunte sobre meteorologia..." maxlength="350">
      <button class="btn btn-primary" onclick="sendZeus()">Enviar</button>
    </div>
  </div>

  <script>
    function toggleZeus() {
      const p = document.getElementById('zeus-panel');
      p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
    }
    document.getElementById('zeus-btn').onclick = toggleZeus;

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }

    async function sendZeus() {
      const input = document.getElementById('zeus-input');
      const msg = input.value.trim();
      if (!msg) return;
      input.value = '';
      const box = document.getElementById('zeus-mensagens');
      const userDiv = document.createElement('div');
      userDiv.className = 'z-user';
      userDiv.textContent = msg;
      box.appendChild(userDiv);
      box.scrollTop = box.scrollHeight;

      let respDiv = document.createElement('div');
      respDiv.className = 'z-assistant';
      respDiv.textContent = 'Digitando...';
      box.appendChild(respDiv);
      box.scrollTop = box.scrollHeight;

      try {
        const r = await fetch('{% url "api_zeus" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
          body: JSON.stringify({pergunta: msg})
        });
        const js = await r.json();
        respDiv.textContent = js.resposta || 'Sem resposta.';
      } catch (e) {
        respDiv.textContent = '⚠️ Erro ao conectar.';
      }
      box.scrollTop = box.scrollHeight;
    }
  </script>
</body>
</html>
