{% extends "siteapp/base.html" %}
{% load static %}

{% block title %}INMET {{ station }} — Manaus{% endblock %}

{% block content %}
<style>
  :root{
    --tabbar-bg:#0d3a2f;
    --panel-bg:#11382e;
    --card-bg1:#102f27; --card-bg2:#0c251f;
    --card-border:#0f3a2e;
    --ink:#e9fff3; --ink-dim:#bfe9da;
  }
  .inmet-tabbar{
    background:var(--tabbar-bg); border-radius:10px; padding:10px 14px;
    box-shadow:0 10px 22px rgba(0,0,0,.18);
    margin:6px 0 18px; display:flex; gap:22px; align-items:center;
  }
  .tabs-pills{ display:flex; flex-wrap:wrap; gap:22px; }
  .tab-pill{
    display:inline-flex; align-items:center; justify-content:center;
    padding:12px 26px; border:2px solid #fff; border-radius:22px;
    background:transparent; color:#fff; font-weight:800; text-decoration:none; line-height:1;
    transition:transform .12s, box-shadow .12s, background .12s, color .12s;
  }
  .tab-pill:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.18); }
  .tab-pill.is-active{ background:#fff; color:var(--tabbar-bg); box-shadow:0 6px 16px rgba(0,0,0,.2); }

  .update-pill{
    background:#fff; color:var(--tabbar-bg); border:2px solid #fff; border-radius:28px;
    padding:10px 14px; box-shadow:0 6px 16px rgba(0,0,0,.15);
    display:inline-flex; align-items:center; gap:10px;
  }
  .update-pill .u-title{
    font-weight:900; font-size:12px; letter-spacing:.6px;
    text-transform:uppercase; opacity:.85;
    background:rgba(13,58,47,.08); padding:4px 8px; border-radius:999px;
  }
  .update-pill .u-dt{ font-weight:900; font-size:18px; white-space:nowrap; }

  .inmet-slab{
    background:var(--panel-bg); border-radius:20px; padding:20px;
    box-shadow:0 10px 26px rgba(0,0,0,.15); border:1px solid rgba(0,0,0,.08);
  }
  .metric-card{
    background:linear-gradient(180deg,var(--card-bg1),var(--card-bg2));
    border:1px solid var(--card-border); border-radius:18px; padding:18px 20px;
    color:var(--ink); box-shadow:inset 0 0 0 1px rgba(255,255,255,.05),0 6px 18px rgba(0,0,0,.22);
    min-height:120px; display:flex; flex-direction:column; justify-content:space-between;
  }
  .metric-label{ color:var(--ink-dim); font-weight:800; font-size:18px; letter-spacing:.3px; margin-bottom:6px; }
  .metric-value{ color:#f5fff9; font-weight:900; font-size:46px; line-height:1.05; text-shadow:0 2px 0 rgba(0,0,0,.25); }
  .map-card{ padding-bottom:12px; }
  .map-box{ height:440px; border-radius:14px; overflow:hidden; }

  /* Chips */
  .compact-row{
    display:flex; gap:12px; align-items:center; white-space:nowrap;
    overflow-x:auto; -webkit-overflow-scrolling:touch; padding:8px 6px 2px; margin-bottom:14px;
  }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border:1.5px solid rgba(255,255,255,.7);
    border-radius:999px; background:rgba(255,255,255,.06);
    color:#fff; font-weight:800; line-height:1;
  }
  .chip .n{ background:#fff; color:#163c2f; font-weight:900; border-radius:10px; padding:2px 8px; }
  .chip small{ opacity:.85; font-weight:700; margin-left:6px; }

  /* ===== Overlay do logo INMET nos gráficos ===== */
  .logo-wrap{ position:relative; }
  .logo-inmet{
    position:absolute; top:-75px; right:14px; width:95px; height:auto;
    opacity:.75; filter: drop-shadow(0 2px 3px rgba(0,0,0,.35));
    pointer-events:none; user-select:none;
  }
  @media (max-width: 576px){
    .logo-inmet{ width:72px; top:10px; right:10px; }
  }
</style>

<!-- Abas -->
<div class="inmet-tabbar">
  <nav class="tabs-pills" role="tablist" aria-label="Abas do painel INMET">
    <a href="?tab=tempo"   class="tab-pill {% if active_tab == 'tempo' %}is-active{% endif %}">Tempo real</a>
    <a href="?tab=diario"  class="tab-pill {% if active_tab == 'diario' %}is-active{% endif %}">Diário</a>
    <a href="?tab=semanal" class="tab-pill {% if active_tab == 'semanal' %}is-active{% endif %}">Semanal</a>
    <a href="?tab=mensal"  class="tab-pill {% if active_tab == 'mensal' %}is-active{% endif %}">Mensal</a>
    <a href="?tab=clima"   class="tab-pill {% if active_tab == 'clima' %}is-active{% endif %}">Climatologia</a>
  </nav>
</div>

{% if error_message %}
  <div class="alert alert-warning">Aviso da API INMET: {{ error_message }}</div>
{% endif %}

{# ===== TEMPO REAL ===== #}
{% if active_tab == 'tempo' %}
  <div class="inmet-slab">
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="mb-3">
          <div class="update-pill">
            <span class="u-title">Última atualização</span>
            <span class="u-dt">{{ update_date|default:"—/—/—" }} · {{ update_time|default:"— (Manaus)" }}</span>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-12 col-md-6"><div class="metric-card"><div class="metric-label">Temperatura do Ar</div><div class="metric-value">{{ rt_temp_value|default:"—" }} °C</div></div></div>
          <div class="col-12 col-md-6"><div class="metric-card"><div class="metric-label">Conforto Térmico</div><div class="metric-value">{{ rt_feels_value|default:"—" }} °C</div></div></div>
          <div class="col-12 col-md-6"><div class="metric-card"><div class="metric-label">Umidade</div><div class="metric-value">{{ rt_humi_value|default:"—" }} %</div></div></div>
          <div class="col-12 col-md-6"><div class="metric-card"><div class="metric-label">Pressão</div><div class="metric-value">{{ rt_pres_value|default:"—" }} hPa</div></div></div>
          <div class="col-12 col-md-6"><div class="metric-card"><div class="metric-label">Vento</div><div class="metric-value">{{ rt_wind_value|default:"—" }} m/s</div></div></div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="metric-card map-card">
          <div class="metric-label mb-2">Localização da estação</div>
          <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
          <div id="map-station" class="map-box"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // Coerção segura de lat/lon (evita quebra do toFixed em strings)
      const lat = Number('{{ station_lat|default:"-3.118" }}');
      const lon = Number('{{ station_lon|default:"-60.021" }}');
      const nome = "{{ station_name|escapejs }}";

      function start(){
        const el = document.getElementById('map-station');
        if(!window.L || !el) return;

        const latOk = Number.isFinite(lat) ? lat : -3.118;
        const lonOk = Number.isFinite(lon) ? lon : -60.021;

        const map = L.map(el, { zoomControl:true }).setView([latOk, lonOk], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const latTxt = Number.isFinite(latOk) ? latOk.toFixed(4) : '—';
        const lonTxt = Number.isFinite(lonOk) ? lonOk.toFixed(4) : '—';

        const mk = L.marker([latOk, lonOk]).addTo(map);
        mk.bindPopup(`<b>${nome}</b><br>Lat: ${latTxt}<br>Lon: ${lonTxt}`).openPopup();

        L.circle([latOk, lonOk], { radius:1500, weight:1, fillOpacity:.05 }).addTo(map);
        L.control.scale({ metric:true, imperial:false }).addTo(map);

        // Garante render correto após layout/flex
        setTimeout(() => map.invalidateSize(true), 150);
      }

      if(!window.L){
        const s=document.createElement('script');
        s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        s.onload=start; document.body.appendChild(s);
      } else { start(); }
    })();
  </script>

{# ===== DIÁRIO ===== #}
{% elif active_tab == 'diario' %}
  <div class="inmet-slab">
    <div class="compact-row"><span class="chip">{{ pill_diario }}</span></div>
    <div class="metric-card logo-wrap">
      {{ graph_daily|safe }}
      <img class="logo-inmet" src="{% static 'img/inmet.png' %}" alt="INMET">
    </div>
  </div>

{# ===== SEMANAL ===== #}
{% elif active_tab == 'semanal' %}
  <div class="inmet-slab">
    <div class="compact-row">
      <span class="chip">Máx <span class="n">{{ week_tmax }}</span> °C {% if week_tmax_day and week_tmax_day != "—" %}<small>({{ week_tmax_day }})</small>{% endif %}</span>
      <span class="chip">Mín <span class="n">{{ week_tmin }}</span> °C {% if week_tmin_day and week_tmin_day != "—" %}<small>({{ week_tmin_day }})</small>{% endif %}</span>
      <span class="chip">Média da semana <span class="n">{{ week_temp_avg }}</span> °C</span>
      <span class="chip">Chuva total <span class="n">{{ week_rain_total }}</span> mm</span>
      <span class="chip"><span class="n">{{ week_rain_days }}</span> dias com chuva</span>
      <span class="chip"><span class="n">{{ week_dry_days }}</span> dias sem chuva</span>
    </div>
    <div class="metric-card logo-wrap">
      {{ graph_week_combo|safe }}
      <img class="logo-inmet" src="{% static 'img/inmet.png' %}" alt="INMET">
    </div>
  </div>

{# ===== MENSAL ===== #}
{% elif active_tab == 'mensal' %}
  <div class="inmet-slab">
    <div class="compact-row">
      <span class="chip">Mês <span class="n">{{ month_label }}</span></span>
      <span class="chip">Máx <span class="n">{{ month_tmax }}</span> °C {% if month_tmax_day and month_tmax_day != "—" %}<small>({{ month_tmax_day }})</small>{% endif %}</span>
      <span class="chip">Mín <span class="n">{{ month_tmin }}</span> °C {% if month_tmin_day and month_tmin_day != "—" %}<small>({{ month_tmin_day }})</small>{% endif %}</span>
      <span class="chip">Chuva total <span class="n">{{ month_rain_total }}</span> mm</span>
      <span class="chip"><span class="n">{{ month_rain_days }}</span> dias com chuva</span>
      <span class="chip"><span class="n">{{ month_dry_days }}</span> dias sem chuva</span>
    </div>
    <div class="metric-card logo-wrap">
      {{ graph_month|safe }}
      <img class="logo-inmet" src="{% static 'img/inmet.png' %}" alt="INMET">
    </div>
  </div>

{# ===== CLIMATOLOGIA ===== #}
{% else %}
  <div class="inmet-slab">
    <div class="compact-row" role="group" aria-label="Resumo da climatologia">
      <span class="chip">Período <span class="n">{{ clima_periodo|default:"1931–1960 vs 1961–1990 vs 1991–2020" }}</span></span>
      <span class="chip">Série <span class="n">INMET</span> <small>(Manaus)</small></span>
      <span class="chip">Unidades <span class="n">°C / mm</span></span>
    </div>

    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="metric-card logo-wrap" aria-label="Climatologia de Temperatura Máxima (por períodos)">
          <div class="metric-label">Temperatura Máxima — Climatologia Mensal</div>
          {{ graph_clima_tmax|safe }}
          <img class="logo-inmet" src="{% static 'img/inmet.png' %}" alt="INMET">
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="metric-card logo-wrap" aria-label="Climatologia de Temperatura Média (por períodos)">
          <div class="metric-label">Temperatura Média — Climatologia Mensal</div>
          {{ graph_clima_tmed|safe }}
          <img class="logo-inmet" src="{% static 'img/inmet.png' %}" alt="INMET">
        </div>
      </div>
    </div>

    <div class="row g-4 mt-1">
      <div class="col-12 col-lg-6">
        <div class="metric-card logo-wrap" aria-label="Climatologia de Temperatura Mínima (por períodos)">
          <div class="metric-label">Temperatura Mínima — Climatologia Mensal</div>
          {{ graph_clima_tmin|safe }}
          <img class="logo-inmet" src="{% static 'img/inmet.png' %}" alt="INMET">
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="metric-card logo-wrap" aria-label="Climatologia de Precipitação (por períodos)">
          <div class="metric-label">Precipitação Acumulada — Climatologia Mensal</div>
          {{ graph_clima_prec|safe }}
          <img class="logo-inmet" src="{% static 'img/inmet.png' %}" alt="INMET">
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% endblock %}
